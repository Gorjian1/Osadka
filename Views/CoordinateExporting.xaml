<UserControl x:Class="Osadka.Views.CoordinateExporting"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:conv="clr-namespace:Osadka.Converters"
             mc:Ignorable="d"
             KeyDown="UserControl_KeyDown">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <conv:AddOneConverter x:Key="AddOne"/>
        <conv:IndexToMarkLabelConverter x:Key="IndexToMark"/>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <ToolBarTray Grid.Row="0" Margin="6,6,6,0">
            <ToolBar>
                <Button x:Name="BtnOpen" Click="BtnOpen_Click" ToolTip="Открыть чертёж">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE8E5;" Margin="0,0,6,0"/>
                        <TextBlock Text="Открыть"/>
                    </StackPanel>
                </Button>
                <Separator/>
                <Button x:Name="BtnRuler" Click="BtnRuler_Click" ToolTip="Режим линейки">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xECDC;" Margin="0,0,6,0"/>
                        <TextBlock Text="Линейка"/>
                    </StackPanel>
                </Button>
                <Button x:Name="BtnSelect" Click="BtnSelect_Click" ToolTip="Режим выбора точек">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xECC8;" Margin="0,0,6,0"/>
                        <TextBlock Text="Выбор точек"/>
                    </StackPanel>
                </Button>
                <Separator/>
                <Button x:Name="BtnExport" Click="BtnExport_Click" ToolTip="Экспорт выбранных точек (Enter)">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xEDE1;" Margin="0,0,6,0"/>
                        <TextBlock Text="Экспорт"/>
                    </StackPanel>
                </Button>
                <Button x:Name="BtnSend" Click="BtnSend_Click" ToolTip="Отправить в исходные данные">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE95A;" Margin="0,0,6,0"/>
                        <TextBlock Text="В исходные данные"/>
                    </StackPanel>
                </Button>
                <Separator/>
                <Button x:Name="BtnLayers" Click="BtnLayers_Click" ToolTip="Выбор слоёв">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xEB22;" Margin="0,0,6,0"/>
                        <TextBlock Text="Слои ▾"/>
                    </StackPanel>
                </Button>
            </ToolBar>
        </ToolBarTray>

        <!-- Drawing area -->
        <Grid Grid.Row="1" Background="White">
            <ScrollViewer x:Name="Viewport"
                          HorizontalScrollBarVisibility="Auto"
                          VerticalScrollBarVisibility="Auto"
                          PreviewMouseWheel="ImageWheel"
                          PreviewMouseRightButtonDown="Viewport_RightDown"
                          PreviewMouseMove="Viewport_Move"
                          PreviewMouseRightButtonUp="Viewport_RightUp"
                          PreviewMouseLeftButtonDown="Viewport_LeftDown">
                <Grid RenderTransformOrigin="0,0">
                    <Grid.LayoutTransform>
                        <ScaleTransform ScaleX="{Binding EffectiveScale}" ScaleY="{Binding EffectiveScale}"/>
                    </Grid.LayoutTransform>

                    <!-- Grid background under the drawing -->
                    <Rectangle x:Name="GridBackground"
                               Width="{Binding ImageWidthPx}"
                               Height="{Binding ImageHeightPx}"
                               Fill="{Binding GridBrush}"
                               Visibility="{Binding GridVisible, Converter={StaticResource BoolToVis}}"
                               IsHitTestVisible="False"/>

                    <!-- CAD drawing -->
                    <Image x:Name="ImageHost"
                           Source="{Binding CadDrawing}"
                           Stretch="None"
                           SnapsToDevicePixels="True"
                           UseLayoutRounding="True"/>

                    <!-- Optional contours -->
                    <ItemsControl ItemsSource="{Binding Contours}" IsHitTestVisible="False">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Polyline Points="{Binding}" Stroke="#1E90FF" StrokeThickness="1"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Overlay for crosses and ruler -->
                    <Canvas x:Name="OverlayCanvas" IsHitTestVisible="False"/>
                </Grid>
            </ScrollViewer>

            <!-- Overlay: selected points list (top-right, under toolbar) -->
            <Border HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,6,6,0"
        Background="#CCFFFFFF" CornerRadius="6" Padding="6" IsHitTestVisible="False">
                <StackPanel>
                    <TextBlock Text="Выбранные точки" FontWeight="Bold" Margin="0,0,0,4"/>
                    <!-- Критично: AlternationCount и привязка к (ItemsControl.AlternationIndex) на контейнере -->
                    <ItemsControl ItemsSource="{Binding SelectedPoints}" AlternationCount="2147483647">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <TextBlock>
<Run Text="№ "/>
<Run>
    <Run.Text>
        <MultiBinding Converter="{StaticResource IndexToMark}">
            <Binding RelativeSource="{RelativeSource AncestorType=FrameworkElement}"
                     Path="(ItemsControl.AlternationIndex)"/>
            <Binding RelativeSource="{RelativeSource AncestorType=UserControl}"
                     Path="DataContext"/>
        </MultiBinding>
    </Run.Text>
</Run>
<Run Text=": "/>

                        <Run Text="{Binding X, StringFormat=F3}"/>
                        <Run Text=" ; "/>
                        <Run Text="{Binding Y, StringFormat=F3}"/>
                                </TextBlock>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>

            <!-- Overlay: grid settings (bottom-left) -->
            <Border HorizontalAlignment="Left" VerticalAlignment="Bottom" Margin="6" Padding="6"
                    Background="#CCFFFFFF" CornerRadius="6">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <CheckBox Content="Сетка" IsChecked="{Binding GridVisible}" Margin="0,0,8,0" VerticalAlignment="Center"/>
                    <TextBlock Text="Шаг:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                    <TextBox Text="{Binding GridStep, UpdateSourceTrigger=PropertyChanged}" Width="60" Margin="0,0,6,0"/>
                    <Button Content="–" Width="26" Click="GridStepMinus_Click" Margin="0,0,4,0"/>
                    <Button Content="+" Width="26" Click="GridStepPlus_Click"/>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</UserControl>
